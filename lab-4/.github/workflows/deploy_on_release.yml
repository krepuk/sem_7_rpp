name: Deploy site on release

on:
  release:
    types: [published]

permissions:
  contents: write
  pages: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare deploy folder
        run: |
          # create temporary folder with site files
          mkdir -p site_to_deploy
          cp -a ru site_to_deploy/ || true
          cp -a en site_to_deploy/ || true
          cp -a index.html site_to_deploy/ || true
          echo "Release: ${{ github.event.release.tag_name }}" > site_to_deploy/RELEASE.txt

      - name: Setup git for pushing
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch gh-pages branch if exists
        run: |
          git fetch origin gh-pages:gh-pages || true

      - name: Switch to gh-pages branch (or create it)
        run: |
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
            git commit --allow-empty -m "Initialize gh-pages"
            git push origin gh-pages
            git checkout gh-pages
          fi

      - name: Copy files into versioned folder
        run: |
          TAG="${{ github.event.release.tag_name }}"
          mkdir -p "v${TAG}"
          # Copy content of site_to_deploy into v<TAG> directory (overwrite)
          cp -a site_to_deploy/. "v${TAG}/"
          # Update top-level index.html (versions index) to include links to all v*/ dirs
          echo "<!doctype html><html><head><meta charset='utf-8'><title>Versions</title></head><body><h1>Available versions</h1><ul>" > versions_index.html
          for d in v*/ ; do
            if [ -d "$d" ]; then
              # strip trailing slash
              name="${d%/}"
              echo "<li><a href='/${{ github.repository }}/$name/'>$name/</a></li>" >> versions_index.html
            fi
          done
          echo "</ul></body></html>" >> versions_index.html
          mv versions_index.html index.html

      - name: Commit and push changes to gh-pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A
          git commit -m "Deploy site for release ${{ github.event.release.tag_name }}" || echo "No changes to commit"
          # Push to gh-pages branch using token auth
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages

      - name: Create GitHub Pages build (if needed)
        uses: actions/github-script@v7
        with:
          script: |
            // optional: nothing here, pages will serve from gh-pages branch once set in repo settings
            core.info("Deployed files to gh-pages branch.")
